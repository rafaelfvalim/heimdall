<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monitor PMS5003 (PM2.5)</title>

  <style>
    :root{
      --bg: #0b1020;
      --surface: rgba(255,255,255,.06);
      --surface-2: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted-2: rgba(255,255,255,.55);
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --radius-sm: 14px;
      --focus: 0 0 0 3px rgba(130, 160, 255, .35);
      --accent1: #7f00ff;   /* Valira vibe */
      --accent2: #00d4ff;
      --ok: #27c29b;
      --warn: #f1b54a;
      --bad: #ff5b6e;
      color-scheme: dark;
    }

    *{ box-sizing: border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Helvetica Neue", "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(127,0,255,.28), transparent 60%),
        radial-gradient(900px 600px at 85% 0%, rgba(0,212,255,.18), transparent 55%),
        radial-gradient(900px 700px at 50% 95%, rgba(255,91,110,.10), transparent 60%),
        var(--bg);
      color: var(--text);
      padding: 28px 16px 60px;
    }

    .wrap{
      max-width: 1120px;
      margin: 0 auto;
    }

    .shell{
      border: 1px solid var(--border);
      border-radius: calc(var(--radius) + 6px);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .topbar{
      padding: 18px 18px 14px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(90deg, rgba(127,0,255,.20), rgba(0,212,255,.12));
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap: wrap;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 260px;
    }

    h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
      line-height: 1.2;
    }

    .subtitle{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
      color: var(--muted);
      font-size: 12px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.18);
      font-size: 12px;
      color: var(--text);
      white-space: nowrap;
    }

    .dot{
      width:8px; height:8px; border-radius: 99px;
      background: rgba(255,255,255,.35);
      box-shadow: 0 0 0 3px rgba(255,255,255,.10);
    }

    .content{
      padding: 18px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(255,255,255,.05);
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
      overflow: hidden;
    }

    .card-h{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .card-h strong{
      font-size: 13px;
      letter-spacing: .2px;
    }

    .muted{
      color: var(--muted);
      font-size: 12px;
    }

    .card-b{ padding: 14px; }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 12px;
      align-items: stretch;
    }

    @media (max-width: 980px){
      .kpis{ grid-template-columns: 1fr; }
    }

    .kpi{
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: rgba(0,0,0,.18);
      padding: 12px;
    }

    .kpi .label{
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
    }

    .kpi .value{
      font-size: 16px;
      font-weight: 650;
      letter-spacing: .2px;
    }

    .kpi .value.big{
      font-size: 18px;
    }

    /* Leituras */
    #kpiReadings{
      margin-top: 10px;
      border-top: 1px solid rgba(255,255,255,.08);
      padding-top: 10px;
    }

    .reading-item{
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .reading-item:last-child{ border-bottom:none; }
    .reading-value{
      font-weight: 700;
      color: var(--text);
    }
    .reading-time{
      color: var(--muted-2);
      font-size: 14px;
      white-space: nowrap;
    }

    /* Data Table */
    .table-container{
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.10);
    }
    .data-table{
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .data-table thead{
      background: rgba(255,255,255,.05);
    }
    .data-table th{
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      color: var(--text);
      border-bottom: 1px solid rgba(255,255,255,.10);
      white-space: nowrap;
    }
    .data-table th.sortable{
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 24px;
    }
    .data-table th.sortable:hover{
      background: rgba(255,255,255,.05);
    }
    .sort-indicator{
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: rgba(255,255,255,.3);
    }
    .data-table th.sortable[data-sort-direction="asc"] .sort-indicator::after{
      content: "‚ñ≤";
      color: var(--text);
    }
    .data-table th.sortable[data-sort-direction="desc"] .sort-indicator::after{
      content: "‚ñº";
      color: var(--text);
    }
    .data-table td{
      padding: 8px 12px;
      color: var(--text);
      border-bottom: 1px solid rgba(255,255,255,.05);
    }
    .data-table tbody tr:hover{
      background: rgba(255,255,255,.03);
    }
    .data-table tbody tr:last-child td{
      border-bottom: none;
    }

    /* Controls */
    .controls{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .row{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: end;
    }

    .field{
      display:flex;
      flex-direction: column;
      gap: 6px;
      min-width: 220px;
    }

    label{
      font-size: 12px;
      color: var(--muted);
    }

    input, select, button{
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      transition: transform .06s ease, border-color .12s ease, background .12s ease, box-shadow .12s ease;
    }

    input:focus, select:focus, button:focus{
      box-shadow: var(--focus);
      border-color: rgba(130,160,255,.45);
    }

    button{
      cursor: pointer;
      font-weight: 650;
    }
    button:active{ transform: translateY(1px); }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      user-select: none;
      white-space: nowrap;
    }

    .btn.primary{
      background: linear-gradient(90deg, rgba(127,0,255,.55), rgba(0,212,255,.35));
      border-color: rgba(255,255,255,.14);
    }
    .btn.ghost{
      background: rgba(255,255,255,.06);
    }
    .btn:hover{
      border-color: rgba(255,255,255,.22);
      background: rgba(255,255,255,.09);
    }
    .btn.primary:hover{
      background: linear-gradient(90deg, rgba(127,0,255,.68), rgba(0,212,255,.42));
    }

    .pills{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .sep{
      height: 1px;
      background: rgba(255,255,255,.10);
      margin: 4px 0;
    }

    /* Chart container */
    .chartbox{
      padding: 10px 12px 12px;
    }
    .chartframe{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      border-radius: var(--radius);
      padding: 12px;
      overflow: hidden;
    }
    canvas{
      width: 100%;
      height: 440px;
    }

    /* Status */
    .status{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .status strong{
      color: var(--text);
      font-weight: 700;
    }

    .hint{
      font-size: 12px;
      color: var(--muted-2);
    }

    /* Small helpers */
    .right{
      margin-left:auto;
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .legend-item {
      position: relative;
      display: inline-block;
      padding: 8px 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: help;
      transition: all 0.2s ease;
    }

    .legend-item:hover {
      background: rgba(255,255,255,.08);
      border-color: var(--accent2);
    }

    .legend-tooltip {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 8px;
      width: 320px;
      padding: 14px;
      background: rgba(11, 16, 32, 0.98);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      box-shadow: 0 10px 26px rgba(0,0,0,.4);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      font-size: 11px;
      line-height: 1.5;
    }

    .legend-item:hover .legend-tooltip {
      opacity: 1;
      pointer-events: auto;
    }

    .legend-tooltip-section {
      margin-bottom: 10px;
    }

    .legend-tooltip-section:last-child {
      margin-bottom: 0;
    }

    .legend-tooltip-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
      font-weight: 600;
    }

    .legend-tooltip-content {
      font-size: 11px;
      color: var(--muted-2);
    }

    .disclaimer-accordion {
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,.03);
    }

    .disclaimer-header {
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s ease;
    }

    .disclaimer-header:hover {
      background: rgba(255,255,255,.05);
    }

    .disclaimer-header strong {
      font-size: 14px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .disclaimer-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      transition: transform 0.3s ease;
    }

    .disclaimer-accordion.active .disclaimer-icon {
      transform: rotate(180deg);
    }

    .disclaimer-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
      padding: 0 18px;
    }

    .disclaimer-accordion.active .disclaimer-content {
      max-height: 500px;
      padding: 0 18px 18px 18px;
    }

    .disclaimer-text {
      font-size: 14px;
      line-height: 1.8;
      color: var(--muted);
      margin: 0;
    }

    .disclaimer-text p {
      margin: 0 0 12px 0;
    }

    .disclaimer-text p:last-child {
      margin-bottom: 0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="shell">
      <div class="topbar">
        <div class="brand">
          <div class="title">
            <h1>Hemdall Monitor ‚Äî IOT Valira</h1>
            <div class="subtitle">
              <span class="badge"><span class="dot"></span> Fonte: <strong>/chart</strong></span>
              <span class="badge">Timezone: <strong>America/S√£o_Paulo</strong></span>
              <span class="badge">Localiza√ß√£o: <strong>Av Sargento Geraldo Santana 240 apto 161 B, Jardim Taquaral, SP</strong></span>
            </div>
          </div>

          <div class="right">
            <span class="badge" id="badgeLive"><span class="dot"></span> Status: <strong id="badgeStatus">‚Äî</strong></span>
          </div>
        </div>
      </div>

      <!-- Legenda dos Tipos de Leitura -->
      <div style="padding: 14px 18px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,.03);">
        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
          <strong style="font-size: 12px; color: var(--muted);">Legenda:</strong>
          
          <!-- PM10 -->
          <div class="legend-item">
            <strong style="font-size: 12px; color: var(--text);">PM10 (‚â§ 10 ¬µm)</strong>
            <div class="legend-tooltip">
              <div style="margin-bottom: 10px;">
                <strong style="font-size: 12px; color: var(--text);">PM10 ‚Äî part√≠culas grossas (‚â§ 10 ¬µm)</strong>
              </div>
              <div class="legend-tooltip-section">
                <div class="legend-tooltip-label">O que s√£o:</div>
                <div class="legend-tooltip-content">Part√≠culas maiores, vis√≠veis como poeira, associadas a processos mec√¢nicos e naturais.</div>
              </div>
              <div class="legend-tooltip-section">
                <div class="legend-tooltip-label">Exemplos comuns:</div>
                <div class="legend-tooltip-content">Poeira de constru√ß√£o, p√≥len, esporos de fungos, part√≠culas de solo levantadas pelo vento.</div>
              </div>
              <div class="legend-tooltip-section">
                <div class="legend-tooltip-label">Origem t√≠pica:</div>
                <div class="legend-tooltip-content">Constru√ß√£o, tr√°fego em estradas de terra, atividades agr√≠colas, erup√ß√µes vulc√¢nicas.</div>
              </div>
              <div class="legend-tooltip-section">
                <div class="legend-tooltip-label">Impacto:</div>
                <div class="legend-tooltip-content">Depositam-se principalmente no nariz e garganta. Irritam vias a√©reas superiores.</div>
              </div>
            </div>
          </div>

          <!-- PM2.5 -->
          <div class="legend-item">
            <strong style="font-size: 12px; color: var(--text);">PM2.5 (‚â§ 2,5 ¬µm)</strong>
            <div class="legend-tooltip">
              <div style="margin-bottom: 10px;">
                <strong style="font-size: 12px; color: var(--text);">PM2.5 ‚Äî part√≠culas finas (‚â§ 2,5 ¬µm)</strong>
              </div>
              <div class="legend-tooltip-section">
                <div class="legend-tooltip-label">O que s√£o:</div>
                <div class="legend-tooltip-content">Part√≠culas muito menores, invis√≠veis a olho nu, associadas a processos de combust√£o.</div>
              </div>
              <div class="legend-tooltip-section">
                <div class="legend-tooltip-label">Exemplos comuns:</div>
                <div class="legend-tooltip-content">Fuma√ßa de cigarros, fuligem (black carbon), aeross√≥is de combust√£o (lenha, carv√£o, √≥leo, diesel), sulfatos, nitratos e am√¥nio, part√≠culas secund√°rias formadas na atmosfera.</div>
              </div>
              <div class="legend-tooltip-section">
                <div class="legend-tooltip-label">Origem t√≠pica:</div>
                <div class="legend-tooltip-content">Ve√≠culos (especialmente diesel), queima de biomassa, inc√™ndios, ind√∫strias, fumo ativo e passivo.</div>
              </div>
              <div class="legend-tooltip-section">
                <div class="legend-tooltip-label">Impacto:</div>
                <div class="legend-tooltip-content">Penetram profundamente nos pulm√µes (alv√©olos). Associadas a doen√ßas respirat√≥rias e cardiovasculares.</div>
              </div>
            </div>
          </div>

          <!-- PM1.0 -->
          <div class="legend-item">
            <strong style="font-size: 12px; color: var(--text);">PM1.0 (‚â§ 1,0 ¬µm)</strong>
            <div class="legend-tooltip">
              <div style="margin-bottom: 10px;">
                <strong style="font-size: 12px; color: var(--text);">PM1.0 ‚Äî part√≠culas ultrafinas (‚â§ 1,0 ¬µm)</strong>
              </div>
              <div class="legend-tooltip-section">
                <div class="legend-tooltip-label">O que s√£o:</div>
                <div class="legend-tooltip-content">Fra√ß√µes ainda mais finas do PM2.5, com maior capacidade de penetra√ß√£o sist√™mica.</div>
              </div>
              <div class="legend-tooltip-section">
                <div class="legend-tooltip-label">Exemplos comuns:</div>
                <div class="legend-tooltip-content">Part√≠culas ultrafinas de combust√£o, aeross√≥is org√¢nicos vol√°teis condensados, metais pesados em suspens√£o, fuma√ßa fresca de cigarro, emiss√µes recentes de motores.</div>
              </div>
              <div class="legend-tooltip-section">
                <div class="legend-tooltip-label">Origem t√≠pica:</div>
                <div class="legend-tooltip-content">Combust√£o recente (cigarros, escapamentos), processos industriais de alta temperatura.</div>
              </div>
              <div class="legend-tooltip-section">
                <div class="legend-tooltip-label">Impacto:</div>
                <div class="legend-tooltip-content">Alcan√ßam os alv√©olos e podem entrar na corrente sangu√≠nea. Maior potencial inflamat√≥rio por unidade de massa.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Aviso Legal / Disclaimer Accordion -->
      <div class="disclaimer-accordion" id="disclaimerAccordion">
        <div class="disclaimer-header" id="disclaimerHeader">
          <strong>
            <span>‚ö†Ô∏è</span>
            <span>Aviso Legal / Disclaimer</span>
          </strong>
          <svg class="disclaimer-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="disclaimer-content">
          <div class="disclaimer-text">
            <p>
              As medi√ß√µes apresentadas nesta p√°gina referem-se exclusivamente ao acompanhamento ambiental de material particulado em suspens√£o no ar (PM1.0, PM2.5 e PM10), coletadas por sensores eletr√¥nicos instalados no interior do apartamento.
            </p>
            <p>
              Os dados t√™m finalidade meramente informativa e de monitoramento, sendo utilizados para registrar ocorr√™ncias recorrentes de fuma√ßa de cigarro que adentram o im√≥vel, com poss√≠vel impacto ao bem-estar, √† sa√∫de e ao sossego dos moradores.
            </p>
            <p>
              Este acompanhamento visa subsidiar registros e documenta√ß√£o relacionados a poss√≠veis situa√ß√µes enquadr√°veis como perturba√ß√£o do sossego, nos termos do art. 42 do Decreto-Lei n¬∫ 3.688/1941 (Lei das Contraven√ß√µes Penais), sem preju√≠zo de outras normas aplic√°veis.
            </p>
          </div>
        </div>
      </div>

      <div class="content">
        <!-- Campos ocultos para vari√°veis de ambiente -->
        <input id="apiBase" type="hidden" value="__API_BASE_URL__" />
        <input id="apiKey" type="hidden" value="__API_KEY__" />

        <div class="grid">
          <!-- KPIs -->
          <div class="card">
            <div class="card-h">
              <strong>Resumo</strong>
              <span class="muted">PM2.5 em ¬µg/m¬≥</span>
            </div>

            <div class="card-b">
              <div class="kpis">
                <div class="kpi" style="display: flex; flex-direction: column; align-items: center; min-width: 220px;">
                  <div class="label" style="margin-bottom: 8px;">Veloc√≠metro PM2.5</div>
                  <div id="gaugeChart" style="width: 220px; height: 200px;"></div>
                  <div id="gaugeValue" style="margin-top: 10px; font-size: 18px; font-weight: 600; color: var(--text);">‚Äî</div>
                  <div id="gaugeStatus" style="margin-top: 4px; font-size: 12px; color: var(--muted-2);">‚Äî</div>
                </div>

                <div class="kpi">
                  <div class="label">√öltimas 5 leituras</div>
                  <div class="value big" style="opacity:.92;">PM2.5</div>
                  <div id="kpiReadings">
                    <div style="text-align:center; color: rgba(255,255,255,.45); padding: 8px 0;">‚Äî</div>
                  </div>
                </div>

                <div class="kpi">
                  <div class="label">Modo</div>
                  <div id="kpiMode" class="value">‚Äî</div>
                  <div class="sep" style="margin:12px 0;"></div>
                  <div class="label">Tipo de leitura</div>
                  <div id="kpiSeriesType" class="value">‚Äî</div>
                </div>

                <div class="kpi">
                  <div class="label">M√©dia (√∫ltimas 5)</div>
                  <div id="kpiAverage" class="value big">‚Äî</div>
                  <div class="sep" style="margin:12px 0;"></div>
                  <div class="label">Exaustor</div>
                  <div id="releStatus" class="value" style="display: flex; align-items: center; gap: 8px;">
                    <span id="releIndicator" style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: #666;"></span>
                    <span id="releText">‚Äî</span>
                  </div>
                  <div class="sep" style="margin:12px 0;"></div>
                  <div class="label">Atualiza√ß√£o</div>
                  <div class="hint">Auto-refresh dispon√≠vel no modo "√∫ltimos minutos".</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Controls -->
          <div class="card">
            <div class="card-h">
              <strong>Controles</strong>
              <span class="muted">Filtros e s√©ries</span>
            </div>

            <div class="card-b">
              <div class="controls">
                <div class="row">
                  <div class="field">
                    <label>Atualiza√ß√£o autom√°tica (modo minutos)</label>
                    <select id="autoRefresh">
                      <option value="on" selected>Ligado (10s)</option>
                      <option value="off">Desligado</option>
                    </select>
                  </div>

                  <div class="field">
                    <label>S√©ries</label>
                    <select id="seriesMode">
                      <option value="pm25" selected>PM2.5</option>
                      <option value="pm25_pm1">PM2.5 + PM1.0</option>
                      <option value="pm25_pm10">PM2.5 + PM10</option>
                      <option value="all">PM1.0 + PM2.5 + PM10</option>
                    </select>
                  </div>
                </div>

                <div class="sep"></div>

                <div class="field" style="min-width: 100%;">
                  <label>√öltimos minutos (r√°pido)</label>
                  <div class="pills">
                    <button class="btn primary" data-min="15">15 min</button>
                    <button class="btn primary" data-min="30">30 min</button>
                    <button class="btn primary" data-min="60">60 min</button>
                    <button class="btn primary" data-min="180">180 min</button>
                  </div>
                </div>

                <div class="row">
                  <div class="field" style="min-width: 240px;">
                    <label>Range (in√≠cio)</label>
                    <input id="startDt" type="datetime-local" />
                  </div>

                  <div class="field" style="min-width: 240px;">
                    <label>Range (fim)</label>
                    <input id="endDt" type="datetime-local" />
                  </div>

                  <button class="btn ghost" id="applyRange">Aplicar range</button>
                  <button class="btn ghost" id="reload">Recarregar</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chart -->
        <div class="card" style="margin-top:14px;">
          <div class="card-h">
            <strong>Gr√°fico</strong>
            <span class="muted">Linha temporal</span>
          </div>

          <div class="chartbox">
            <div class="chartframe">
              <canvas id="chart"></canvas>

              <div class="status">
                <div id="status">‚Äî</div>
                <div class="hint">Dica: use "√∫ltimos minutos" para auto-refresh.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Picos de Leituras -->
        <div class="card" style="margin-top:14px;">
          <div class="card-h">
            <strong>Picos de Leituras PM2.5</strong>
            <div style="display: flex; align-items: center; gap: 10px;">
              <span class="muted">Acionamentos do rel√©</span>
              <button class="btn ghost" id="exportPicos" style="font-size: 12px; padding: 6px 12px;">
                üìä Exportar para Excel
              </button>
            </div>
          </div>

          <div class="card-b">
            <div class="controls">
              <div class="row">
                <div class="field" style="min-width: 240px;">
                  <label>Data/Hora In√≠cio</label>
                  <input id="picosStartDt" type="datetime-local" />
                </div>

                <div class="field" style="min-width: 240px;">
                  <label>Data/Hora Fim</label>
                  <input id="picosEndDt" type="datetime-local" />
                </div>

                <button class="btn primary" id="fetchPicos">Buscar Picos</button>
              </div>
            </div>

            <div style="margin-top: 20px;">
              <div id="picosSummary" style="padding: 16px; background: rgba(255,255,255,.04); border-radius: var(--radius-sm); margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="font-size: 14px; color: var(--muted);">Total de ocorr√™ncias:</div>
                  <div id="picosTotal" style="font-size: 24px; font-weight: 600; color: var(--accent2);">‚Äî</div>
                </div>
              </div>

              <div class="table-container">
                <table id="picosTable" class="data-table">
                  <thead>
                    <tr>
                      <th class="sortable" data-sort="date">
                        Data <span class="sort-indicator"></span>
                      </th>
                      <th class="sortable" data-sort="time">
                        Hor√°rio <span class="sort-indicator"></span>
                      </th>
                      <th class="sortable" data-sort="previous">
                        Valor Anterior (¬µg/m¬≥) <span class="sort-indicator"></span>
                      </th>
                      <th class="sortable" data-sort="current">
                        Valor Atual (¬µg/m¬≥) <span class="sort-indicator"></span>
                      </th>
                      <th class="sortable" data-sort="increase">
                        Aumento (¬µg/m¬≥) <span class="sort-indicator"></span>
                      </th>
                    </tr>
                  </thead>
                  <tbody id="picosTableBody">
                    <tr><td colspan="5" style="text-align: center; color: rgba(255,255,255,.45); padding: 20px;">Selecione um range de data/hora e clique em "Buscar Picos"</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Leitura Integral dos Dados -->
        <div class="card" style="margin-top:14px;">
          <div class="card-h">
            <strong>Leitura Integral dos Dados</strong>
            <div style="display: flex; align-items: center; gap: 10px;">
              <span class="muted">Tabela completa de leituras</span>
              <button class="btn ghost" id="exportData" style="font-size: 12px; padding: 6px 12px;">
                üìä Exportar para Excel
              </button>
            </div>
          </div>

          <div class="card-b">
            <div class="table-container">
              <table id="dataTable" class="data-table">
                <thead>
                  <tr>
                    <th class="sortable" data-sort="date">
                      Data <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable" data-sort="time">
                      Hor√°rio <span class="sort-indicator"></span>
                    </th>
                    <th id="colPm1" class="sortable" data-sort="pm1" style="display: none;">
                      PM1.0 (¬µg/m¬≥) <span class="sort-indicator"></span>
                    </th>
                    <th id="colPm25" class="sortable" data-sort="pm25">
                      PM2.5 (¬µg/m¬≥) <span class="sort-indicator"></span>
                    </th>
                    <th id="colPm10" class="sortable" data-sort="pm10" style="display: none;">
                      PM10 (¬µg/m¬≥) <span class="sort-indicator"></span>
                    </th>
                  </tr>
                </thead>
                <tbody id="tableBody">
                  <tr><td colspan="5" style="text-align: center; color: rgba(255,255,255,.45); padding: 20px;">Carregando dados...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div><!-- /content -->
    </div><!-- /shell -->
  </div><!-- /wrap -->

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // Estado do filtro
    let mode = { type: "last_minutes", minutes: 60, start: null, end: null };
    let timer = null;

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");

    function setStatus(msg) {
      statusEl.textContent = msg;
      const badge = $("badgeStatus");
      if (badge) badge.textContent = msg.startsWith("OK") ? "OK" : (msg.startsWith("Erro") ? "Erro" : "‚Äî");
    }

    // Converte datetime-local (hor√°rio de S√£o Paulo) para ISO UTC (Z) para enviar √† API
    function localInputToUtcIsoZ(value) {
      if (!value) return null;

      const [datePart, timePart] = value.split("T");
      if (!datePart || !timePart) return null;

      let candidate = new Date(datePart + "T" + timePart + ":00Z");
      candidate.setHours(candidate.getHours() + 3); // aproxima√ß√£o

      for (let i = 0; i < 10; i++) {
        const formatter = new Intl.DateTimeFormat("en-US", {
          timeZone: "America/Sao_Paulo",
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false
        });

        const parts = formatter.formatToParts(candidate);
        const formattedHour = parts.find(p => p.type === "hour").value;
        const formattedMinute = parts.find(p => p.type === "minute").value;
        const [desiredHour, desiredMinute] = timePart.split(":");

        if (formattedHour === desiredHour && formattedMinute === desiredMinute) break;

        const hourDiff = parseInt(desiredHour) - parseInt(formattedHour);
        candidate.setHours(candidate.getHours() + hourDiff);
      }

      if (Number.isNaN(candidate.getTime())) return null;
      return candidate.toISOString();
    }

    // Converte ISO UTC para hor√°rio de S√£o Paulo e formata
    function fmtTime(isoZ) {
      try {
        const date = new Date(isoZ);
        const formatter = new Intl.DateTimeFormat("pt-BR", {
          timeZone: "America/Sao_Paulo",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: false
        });
        return formatter.format(date) + " BRT";
      } catch {
        return isoZ;
      }
    }

    const ctx = $("chart");

    // Vari√°vel para armazenar o gauge do Plotly
    let gaugeChart = null;

    // Fun√ß√£o para desenhar o veloc√≠metro usando Plotly
    function drawGauge(value) {
      const gaugeContainer = document.getElementById("gaugeChart");
      if (!gaugeContainer) return;
      
      // Define os limites e cores
      const maxValue = 50; // Valor m√°ximo para o gauge
      const greenMax = 12.0;
      const yellowMax = 35.4;
      
      // Determina a cor e status baseada no valor
      let color, status, displayValue;
      if (value === null || value === undefined || isNaN(value)) {
        color = "#666";
        status = "Sem dados";
        displayValue = 0; // Para exibir no gauge
      } else {
        displayValue = value;
        if (value <= greenMax) {
          color = "#4CAF50"; // Verde
          status = "Bom";
        } else if (value <= yellowMax) {
          color = "#FFC107"; // Amarelo
          status = "Moderado";
        } else {
          color = "#F44336"; // Vermelho
          status = "Ruim";
        }
      }
      
      // Configura√ß√£o do gauge do Plotly
      
      const data = [{
        type: "indicator",
        mode: "gauge+number",
        value: displayValue,
        domain: { x: [0, 1], y: [0, 1] },
        title: { 
          text: "PM2.5<br><span style='font-size:0.7em;color:rgba(255,255,255,0.5)'>¬µg/m¬≥</span>",
          font: { size: 14, color: "rgba(255,255,255,0.92)" }
        },
        number: {
          font: { size: 20, color: color },
          valueformat: ".1f"
        },
        gauge: {
          axis: { 
            range: [0, maxValue],
            tickcolor: "rgba(255,255,255,0.5)",
            tickfont: { color: "rgba(255,255,255,0.7)", size: 10 },
            tickwidth: 1
          },
          bar: { 
            color: color === "#666" ? "rgba(255,255,255,0.8)" : color,
            line: { color: "rgba(255,255,255,1)", width: 4 },
            thickness: 0.6
          },
          bgcolor: "rgba(0,0,0,0.1)",
          borderwidth: 2,
          bordercolor: "rgba(255,255,255,0.1)",
          steps: [
            { range: [0, greenMax], color: "#4CAF50" },
            { range: [greenMax, yellowMax], color: "#FFC107" },
            { range: [yellowMax, maxValue], color: "#F44336" }
          ],
          threshold: {
            line: { color: "red", width: 4 },
            thickness: 0.75,
            value: maxValue
          }
        }
      }];
      
      const layout = {
        width: 220,
        height: 200,
        margin: { t: 20, b: 20, l: 20, r: 20 },
        paper_bgcolor: "transparent",
        plot_bgcolor: "transparent",
        font: { color: "rgba(255,255,255,0.92)", size: 12 }
      };
      
      const config = {
        displayModeBar: false,
        responsive: true
      };
      
      // Sempre recria o gr√°fico para garantir que o ponteiro apare√ßa
      Plotly.newPlot("gaugeChart", data, layout, config);
      gaugeChart = true;
      
      // Atualiza o valor e status
      const gaugeValue = $("gaugeValue");
      const gaugeStatus = $("gaugeStatus");
      
      if (gaugeValue) {
        if (value !== null && value !== undefined && !isNaN(value)) {
          gaugeValue.textContent = value.toFixed(1) + " ¬µg/m¬≥";
          gaugeValue.style.color = color;
        } else {
          gaugeValue.textContent = "‚Äî";
          gaugeValue.style.color = "var(--text)";
        }
      }
      
      if (gaugeStatus) {
        gaugeStatus.textContent = status;
        gaugeStatus.style.color = color;
      }
    }

    const chart = new Chart(ctx, {
      type: "line",
      data: { labels: [], datasets: [] },
      options: {
        responsive: true,
        animation: false,
        interaction: { mode: "index", intersect: false },
        plugins: { legend: { display: true } },
        scales: {
          x: { ticks: { maxTicksLimit: 10 } },
          y: { beginAtZero: true }
        }
      }
    });

    function buildDatasets(seriesMode, series) {
      const ds = [];
      const add = (label, data) => ds.push({ label, data, tension: 0.25, pointRadius: 0 });

      if (seriesMode === "pm25") add("PM2.5 (¬µg/m¬≥)", series.pm25);
      if (seriesMode === "pm25_pm1") { add("PM2.5 (¬µg/m¬≥)", series.pm25); add("PM1.0 (¬µg/m¬≥)", series.pm1); }
      if (seriesMode === "pm25_pm10") { add("PM2.5 (¬µg/m¬≥)", series.pm25); add("PM10 (¬µg/m¬≥)", series.pm10); }
      if (seriesMode === "all") { add("PM1.0 (¬µg/m¬≥)", series.pm1); add("PM2.5 (¬µg/m¬≥)", series.pm25); add("PM10 (¬µg/m¬≥)", series.pm10); }

      return ds;
    }

    async function fetchChart() {
      const base = $("apiBase").value.replace(/\/+$/, "");
      const apiKey = $("apiKey").value.trim();

      if (!apiKey) {
        setStatus("Erro: API Key √© obrigat√≥ria.");
        return;
      }

      let url = base + "/chart?limit=2000&api_key=" + encodeURIComponent(apiKey);

      const seriesMode = $("seriesMode").value;

      if (mode.type === "last_minutes") {
        url += "&last_minutes=" + encodeURIComponent(String(mode.minutes));
        $("kpiMode").textContent = `√öltimos ${mode.minutes} min`;
      } else {
        url += "&start=" + encodeURIComponent(mode.start) + "&end=" + encodeURIComponent(mode.end);
        $("kpiMode").textContent = `Range`;
      }

      const seriesTypeMap = {
        "pm25": "PM2.5",
        "pm25_pm1": "PM2.5 + PM1.0",
        "pm25_pm10": "PM2.5 + PM10",
        "all": "PM1.0 + PM2.5 + PM10"
      };
      $("kpiSeriesType").textContent = seriesTypeMap[seriesMode] || "‚Äî";

      const startMs = Date.now();
      setStatus("Carregando‚Ä¶");

      let res;
      try {
        res = await fetch(url, { cache: "no-store" });
      } catch (fetchError) {
        if (fetchError.message.includes("Failed to fetch") || fetchError.message.includes("network")) {
          throw new Error("CORS: A API bloqueou a requisi√ß√£o. Configure CORS no servidor para permitir localhost ou use um proxy.");
        }
        throw fetchError;
      }

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const js = await res.json();
      if (!js.ok) throw new Error("Resposta inv√°lida da API");

      const labels = (js.labels || []).map(iso => fmtTime(iso));
      const series = js.series || { pm1: [], pm25: [], pm10: [] };

      const datasets = buildDatasets(seriesMode, series);

      chart.data.labels = labels;
      chart.data.datasets = datasets;
      chart.update();

      // KPI: √∫ltimas 5 leituras de PM2.5
      const readingsContainer = $("kpiReadings");
      const pm25 = series.pm25 || [];
      const labelsIso = js.labels || [];

      const validReadings = [];
      for (let i = labelsIso.length - 1; i >= 0; i--) {
        if (pm25[i] !== null && pm25[i] !== undefined) {
          validReadings.push({ value: pm25[i], time: labelsIso[i], index: i });
          if (validReadings.length >= 5) break;
        }
      }

      if (validReadings.length > 0) {
        readingsContainer.innerHTML = validReadings.map(reading => {
          return `
            <div class="reading-item">
              <span class="reading-value">${Number(reading.value).toFixed(1)} ¬µg/m¬≥</span>
              <span class="reading-time">${fmtTime(reading.time)}</span>
            </div>
          `;
        }).join("");

        const sum = validReadings.reduce((acc, reading) => acc + Number(reading.value), 0);
        const average = sum / validReadings.length;
        $("kpiAverage").textContent = average.toFixed(1) + " ¬µg/m¬≥";
        
        // Atualiza o veloc√≠metro com o √∫ltimo valor
        const lastValue = validReadings[0].value;
        drawGauge(lastValue);
      } else {
        readingsContainer.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,.45); padding: 8px 0;">Nenhuma leitura dispon√≠vel</div>';
        $("kpiAverage").textContent = "‚Äî";
        drawGauge(null);
      }

      // Atualiza tabela de dados
      updateDataTable(labels, series, seriesMode, js.labels || []);

      setStatus(`OK ‚Ä¢ pontos: ${js.meta?.points ?? labels.length} ‚Ä¢ ${Date.now() - startMs} ms`);
    }

    // Vari√°veis globais para ordena√ß√£o
    let tableData = [];
    let currentSort = { column: null, direction: null };
    let tableListenersAdded = false;
    let picosData = []; // Armazena dados originais dos picos

    function updateDataTable(labels, series, seriesMode, labelsIso) {
      const tableBody = $("tableBody");
      const pm1 = series.pm1 || [];
      const pm25 = series.pm25 || [];
      const pm10 = series.pm10 || [];
      
      // Reseta ordena√ß√£o quando novos dados s√£o carregados
      currentSort = { column: null, direction: null };
      document.querySelectorAll('.data-table th.sortable').forEach(h => {
        h.removeAttribute('data-sort-direction');
      });
      
      // Mostra/oculta colunas baseado no filtro selecionado
      const showPm1 = seriesMode === "pm25_pm1" || seriesMode === "all";
      const showPm25 = true; // Sempre mostra PM2.5
      const showPm10 = seriesMode === "pm25_pm10" || seriesMode === "all";
      
      $("colPm1").style.display = showPm1 ? "table-cell" : "none";
      $("colPm10").style.display = showPm10 ? "table-cell" : "none";
      
      // Fun√ß√£o auxiliar para formatar apenas a data
      function fmtDate(isoZ) {
        try {
          const date = new Date(isoZ);
          const formatter = new Intl.DateTimeFormat("pt-BR", {
            timeZone: "America/Sao_Paulo",
            year: "numeric",
            month: "2-digit",
            day: "2-digit"
          });
          return formatter.format(date);
        } catch {
          return isoZ;
        }
      }

      if (labels.length === 0) {
        const colCount = 2 + (showPm1 ? 1 : 0) + 1 + (showPm10 ? 1 : 0); // +1 para coluna Data
        tableBody.innerHTML = `<tr><td colspan="${colCount}" style="text-align: center; color: rgba(255,255,255,.45); padding: 20px;">Nenhum dado dispon√≠vel</td></tr>`;
        tableData = [];
        return;
      }
      
      // Armazena os dados para ordena√ß√£o
      tableData = [];
      for (let i = 0; i < labels.length; i++) {
        tableData.push({
          date: fmtDate(labelsIso[i]),
          time: labels[i],
          timeIso: labelsIso[i],
          pm1: pm1[i] !== null && pm1[i] !== undefined ? Number(pm1[i]) : null,
          pm25: pm25[i] !== null && pm25[i] !== undefined ? Number(pm25[i]) : null,
          pm10: pm10[i] !== null && pm10[i] !== undefined ? Number(pm10[i]) : null
        });
      }
      
      // Renderiza a tabela
      renderTable(showPm1, showPm10);
      
      // Adiciona event listeners nos cabe√ßalhos (apenas uma vez)
      if (!tableListenersAdded) {
        document.querySelectorAll('.data-table th.sortable').forEach(th => {
          th.addEventListener('click', () => {
            const sortColumn = th.getAttribute('data-sort');
            if (currentSort.column === sortColumn) {
              // Alterna dire√ß√£o se clicar na mesma coluna
              currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
              // Nova coluna, come√ßa com ascendente
              currentSort.column = sortColumn;
              currentSort.direction = 'asc';
            }
            
            // Atualiza indicadores visuais
            document.querySelectorAll('.data-table th.sortable').forEach(h => {
              h.removeAttribute('data-sort-direction');
            });
            th.setAttribute('data-sort-direction', currentSort.direction);
            
            // Re-renderiza a tabela
            renderTable(showPm1, showPm10);
          });
        });
        tableListenersAdded = true;
      }
    }

    function renderTable(showPm1, showPm10) {
      const tableBody = $("tableBody");
      
      if (tableData.length === 0) {
        const colCount = 2 + (showPm1 ? 1 : 0) + 1 + (showPm10 ? 1 : 0); // +1 para coluna Data
        tableBody.innerHTML = `<tr><td colspan="${colCount}" style="text-align: center; color: rgba(255,255,255,.45); padding: 20px;">Nenhum dado dispon√≠vel</td></tr>`;
        return;
      }
      
      // Ordena os dados
      let sortedData = [...tableData];
      if (currentSort.column && currentSort.direction) {
        sortedData.sort((a, b) => {
          let aVal, bVal;
          
          if (currentSort.column === 'time' || currentSort.column === 'date') {
            // Ordena por data/hora (usa ISO para compara√ß√£o)
            aVal = new Date(a.timeIso).getTime();
            bVal = new Date(b.timeIso).getTime();
          } else {
            // Ordena por valor num√©rico
            aVal = a[currentSort.column] !== null ? a[currentSort.column] : -Infinity;
            bVal = b[currentSort.column] !== null ? b[currentSort.column] : -Infinity;
          }
          
          if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
          if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
          return 0;
        });
      } else {
        // Ordena√ß√£o padr√£o: mais recente primeiro (reverso do √≠ndice)
        sortedData.reverse();
      }
      
      // Cria as linhas da tabela
      const rows = sortedData.map(item => {
        const row = [];
        row.push(`<td>${item.date}</td>`);
        row.push(`<td>${item.time}</td>`);
        
        if (showPm1) {
          const pm1Value = item.pm1 !== null ? item.pm1.toFixed(1) : "‚Äî";
          row.push(`<td>${pm1Value}</td>`);
        }
        
        const pm25Value = item.pm25 !== null ? item.pm25.toFixed(1) : "‚Äî";
        const pm25Color = getPm25Color(item.pm25);
        row.push(`<td style="color: ${pm25Color}; font-weight: 600;">${pm25Value}</td>`);
        
        if (showPm10) {
          const pm10Value = item.pm10 !== null ? item.pm10.toFixed(1) : "‚Äî";
          row.push(`<td>${pm10Value}</td>`);
        }
        
        return `<tr>${row.join("")}</tr>`;
      });
      
      tableBody.innerHTML = rows.join("");
    }

    // Fun√ß√£o para buscar o estado do rel√©
    async function fetchReleStatus() {
      const base = $("apiBase").value.replace(/\/+$/, "");
      const apiKey = $("apiKey").value.trim();

      if (!apiKey) {
        return;
      }

      // Constr√≥i a URL do rel√©
      // A URL base √© algo como: https://sites-automator.aal5pu.easypanel.host
      // A URL do rel√© √©: https://sites-api-rele.aal5pu.easypanel.host/rele
      let releUrl;
      try {
        const urlObj = new URL(base);
        // Substitui "automator" por "api-rele" no hostname
        // sites-automator -> sites-api-rele
        const hostname = urlObj.hostname.replace("sites-automator", "sites-api-rele");
        releUrl = `${urlObj.protocol}//${hostname}/rele`;
      } catch (e) {
        // Fallback: substitui diretamente na string
        releUrl = base.replace("sites-automator", "sites-api-rele").replace(/\/chart.*$/, "") + "/rele";
        if (!releUrl.startsWith("http")) {
          releUrl = base.replace(/\/chart.*$/, "").replace("automator", "api-rele") + "/rele";
        }
      }
      
      releUrl += "?api_key=" + encodeURIComponent(apiKey);

      try {
        const res = await fetch(releUrl, { cache: "no-store" });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json();
        
        if (data.ok) {
          const releIndicator = $("releIndicator");
          const releText = $("releText");
          
          // pm25_detected_increase indica o estado do acionamento
          const isOn = data.pm25_detected_increase === true;
          
          if (releIndicator) {
            releIndicator.style.backgroundColor = isOn ? "#4CAF50" : "#666";
          }
          
          if (releText) {
            releText.textContent = isOn ? "ON" : "OFF";
            releText.style.color = isOn ? "#4CAF50" : "var(--muted-2)";
          }
        }
      } catch (e) {
        // Silenciosamente falha se n√£o conseguir buscar o estado do rel√©
        console.error("Erro ao buscar estado do rel√©:", e);
        const releIndicator = $("releIndicator");
        const releText = $("releText");
        if (releIndicator) releIndicator.style.backgroundColor = "#666";
        if (releText) {
          releText.textContent = "‚Äî";
          releText.style.color = "var(--muted-2)";
        }
      }
    }

    async function reloadNow() {
      try {
        await fetchChart();
        await fetchReleStatus(); // Busca o estado do rel√© junto com os dados do gr√°fico
      } catch (e) {
        let errorMsg = e.message || String(e);
        if (errorMsg.includes("CORS") || errorMsg.includes("blocked") ||
            errorMsg.includes("Access-Control") || errorMsg.includes("Failed to fetch") ||
            errorMsg.includes("network")) {
          errorMsg = "CORS: A API bloqueou a requisi√ß√£o. Configure CORS no servidor para permitir localhost ou use um proxy CORS.";
        }
        setStatus("Erro: " + errorMsg);
        console.error("Erro ao carregar dados:", e);
      }
    }

    function resetTimerIfNeeded() {
      if (timer) { clearInterval(timer); timer = null; }

      const auto = $("autoRefresh").value;
      if (auto === "on" && mode.type === "last_minutes") {
        timer = setInterval(reloadNow, 10000);
      }
    }

    // Bot√µes de minutos
    document.querySelectorAll("button[data-min]").forEach(btn => {
      btn.addEventListener("click", () => {
        const m = Number(btn.getAttribute("data-min"));
        mode = { type: "last_minutes", minutes: m, start: null, end: null };
        resetTimerIfNeeded();
        reloadNow();
      });
    });

    // Aplicar range
    $("applyRange").addEventListener("click", () => {
      const startIso = localInputToUtcIsoZ($("startDt").value);
      const endIso = localInputToUtcIsoZ($("endDt").value);

      if (!startIso || !endIso) {
        setStatus("Preencha in√≠cio e fim do range.");
        return;
      }
      mode = { type: "range", start: startIso, end: endIso, minutes: null };
      resetTimerIfNeeded();
      reloadNow();
    });

    $("reload").addEventListener("click", () => reloadNow());
    $("autoRefresh").addEventListener("change", () => resetTimerIfNeeded());
    $("seriesMode").addEventListener("change", () => reloadNow());

    // Fun√ß√£o gen√©rica para inicializar ordena√ß√£o de tabela
    function initTableSorting(tableId, tbodyId) {
      const table = document.getElementById(tableId);
      if (!table) return;

      const tbody = document.getElementById(tbodyId);
      if (!tbody) return;

      // Remove listeners anteriores se existirem
      const headers = table.querySelectorAll('th.sortable');
      headers.forEach(th => {
        const newTh = th.cloneNode(true);
        th.parentNode.replaceChild(newTh, th);
      });

      // Adiciona novos listeners
      table.querySelectorAll('th.sortable').forEach(th => {
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => {
          const sortColumn = th.getAttribute('data-sort');
          const rows = Array.from(tbody.querySelectorAll('tr'));
          
          // Remove indicadores de todas as colunas
          table.querySelectorAll('th.sortable').forEach(h => {
            h.removeAttribute('data-sort-direction');
            const indicator = h.querySelector('.sort-indicator');
            if (indicator) indicator.textContent = '';
          });

          // Determina dire√ß√£o
          const currentDir = th.getAttribute('data-sort-direction');
          const newDir = currentDir === 'asc' ? 'desc' : 'asc';
          th.setAttribute('data-sort-direction', newDir);
          
          const indicator = th.querySelector('.sort-indicator');
          if (indicator) indicator.textContent = newDir === 'asc' ? ' ‚Üë' : ' ‚Üì';

          // Ordena as linhas
          rows.sort((a, b) => {
            const aCell = a.querySelector(`td:nth-child(${Array.from(th.parentNode.children).indexOf(th) + 1})`);
            const bCell = b.querySelector(`td:nth-child(${Array.from(th.parentNode.children).indexOf(th) + 1})`);
            
            if (!aCell || !bCell) return 0;
            
            let aVal = aCell.textContent.trim();
            let bVal = bCell.textContent.trim();
            
            // Tenta converter para n√∫mero
            const aNum = parseFloat(aVal);
            const bNum = parseFloat(bVal);
            
            if (!isNaN(aNum) && !isNaN(bNum)) {
              return newDir === 'asc' ? aNum - bNum : bNum - aNum;
            }
            
            // Ordena√ß√£o por data/hora (cont√©m "BRT")
            if (aVal.includes('BRT') && bVal.includes('BRT')) {
              const aDate = new Date(aVal.replace(' BRT', ''));
              const bDate = new Date(bVal.replace(' BRT', ''));
              return newDir === 'asc' ? aDate - bDate : bDate - aDate;
            }
            
            // Ordena√ß√£o alfab√©tica
            return newDir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
          });

          // Reordena as linhas no DOM
          rows.forEach(row => tbody.appendChild(row));
        });
      });
    }

    // Fun√ß√£o auxiliar para determinar a cor baseada no valor de PM2.5
    function getPm25Color(value) {
      if (value === null || value === undefined || isNaN(value)) {
        return "var(--text)"; // Cor padr√£o para valores inv√°lidos
      }
      const numValue = Number(value);
      if (numValue <= 12.0) {
        return "#4CAF50"; // Verde (Bom)
      } else if (numValue <= 35.4) {
        return "#FFC107"; // Amarelo (Moderado)
      } else {
        return "#F44336"; // Vermelho (Ruim)
      }
    }

    // Fun√ß√£o para buscar picos de leituras
    async function fetchPicos() {
      const base = $("apiBase").value.replace(/\/+$/, "");
      const apiKey = $("apiKey").value.trim();

      if (!apiKey) {
        alert("Erro: API Key √© obrigat√≥ria.");
        return;
      }

      const startIso = localInputToUtcIsoZ($("picosStartDt").value);
      const endIso = localInputToUtcIsoZ($("picosEndDt").value);

      if (!startIso || !endIso) {
        alert("Preencha a data/hora de in√≠cio e fim.");
        return;
      }

      // Constr√≥i a URL da API de picos
      let picosUrl;
      try {
        const urlObj = new URL(base);
        const hostname = urlObj.hostname.replace("sites-automator", "sites-api-rele");
        picosUrl = `${urlObj.protocol}//${hostname}/rele/picos`;
      } catch (e) {
        picosUrl = base.replace("sites-automator", "sites-api-rele").replace(/\/chart.*$/, "") + "/rele/picos";
        if (!picosUrl.startsWith("http")) {
          picosUrl = base.replace(/\/chart.*$/, "").replace("automator", "api-rele") + "/rele/picos";
        }
      }

      picosUrl += "?start=" + encodeURIComponent(startIso) + "&end=" + encodeURIComponent(endIso) + "&api_key=" + encodeURIComponent(apiKey);

      const tableBody = $("picosTableBody");
      const picosTotal = $("picosTotal");

      tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: rgba(255,255,255,.45); padding: 20px;">Carregando...</td></tr>';

      try {
        const res = await fetch(picosUrl, { cache: "no-store" });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json();

        if (!data.ok) {
          throw new Error("Resposta inv√°lida da API");
        }

        const occurrences = data.occurrences || [];
        const total = data.total_occurrences || occurrences.length;

        // Atualiza o total
        if (picosTotal) {
          picosTotal.textContent = total;
        }

        // Armazena dados originais para exporta√ß√£o
        picosData = occurrences;

        // Fun√ß√£o auxiliar para formatar apenas a data
        function fmtDate(isoZ) {
          try {
            const date = new Date(isoZ);
            const formatter = new Intl.DateTimeFormat("pt-BR", {
              timeZone: "America/Sao_Paulo",
              year: "numeric",
              month: "2-digit",
              day: "2-digit"
            });
            return formatter.format(date);
          } catch {
            return isoZ;
          }
        }

        // Atualiza a tabela
        if (occurrences.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: rgba(255,255,255,.45); padding: 20px;">Nenhum pico encontrado no per√≠odo selecionado</td></tr>';
          picosData = [];
        } else {
          tableBody.innerHTML = occurrences.map(occ => {
            const date = fmtDate(occ.timestamp);
            const time = fmtTime(occ.timestamp);
            const previousValue = occ.previous_value !== null && occ.previous_value !== undefined ? Number(occ.previous_value) : null;
            const currentValue = occ.current_value !== null && occ.current_value !== undefined ? Number(occ.current_value) : null;
            const previous = previousValue !== null ? previousValue.toFixed(1) : "‚Äî";
            const current = currentValue !== null ? currentValue.toFixed(1) : "‚Äî";
            const increase = occ.increase !== null && occ.increase !== undefined ? Number(occ.increase).toFixed(1) : "‚Äî";
            
            // Determina cores baseadas nos valores
            const previousColor = getPm25Color(previousValue);
            const currentColor = getPm25Color(currentValue);
            
            return `
              <tr>
                <td>${date}</td>
                <td>${time}</td>
                <td style="color: ${previousColor}; font-weight: 600;">${previous}</td>
                <td style="color: ${currentColor}; font-weight: 600;">${current}</td>
                <td style="color: ${Number(occ.increase) > 50 ? '#F44336' : Number(occ.increase) > 20 ? '#FFC107' : '#4CAF50'}; font-weight: 600;">${increase}</td>
              </tr>
            `;
          }).join("");

          // Adiciona ordena√ß√£o √† tabela de picos
          initTableSorting("picosTable", "picosTableBody");
        }
      } catch (e) {
        let errorMsg = e.message || String(e);
        if (errorMsg.includes("CORS") || errorMsg.includes("blocked") ||
            errorMsg.includes("Access-Control") || errorMsg.includes("Failed to fetch") ||
            errorMsg.includes("network")) {
          errorMsg = "CORS: A API bloqueou a requisi√ß√£o. Configure CORS no servidor.";
        }
        tableBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: #F44336; padding: 20px;">Erro: ${errorMsg}</td></tr>`;
        if (picosTotal) {
          picosTotal.textContent = "‚Äî";
        }
        console.error("Erro ao buscar picos:", e);
      }
    }

    // Fun√ß√£o para obter a data/hora atual no fuso de S√£o Paulo no formato datetime-local
    function getTodayInSaoPaulo() {
      const now = new Date();
      
      // Obt√©m a data/hora atual em S√£o Paulo
      const formatter = new Intl.DateTimeFormat("en-CA", {
        timeZone: "America/Sao_Paulo",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      });
      
      const parts = formatter.formatToParts(now);
      const year = parts.find(p => p.type === "year").value;
      const month = parts.find(p => p.type === "month").value;
      const day = parts.find(p => p.type === "day").value;
      const hour = parts.find(p => p.type === "hour").value;
      const minute = parts.find(p => p.type === "minute").value;
      
      return {
        date: `${year}-${month}-${day}`,
        start: `${year}-${month}-${day}T00:00`,
        end: `${year}-${month}-${day}T23:59`
      };
    }

    // Fun√ß√£o para inicializar os campos de data/hora dos picos com o dia atual
    function initPicosDateRange() {
      const today = getTodayInSaoPaulo();
      const startInput = $("picosStartDt");
      const endInput = $("picosEndDt");
      
      if (startInput && endInput) {
        startInput.value = today.start;
        endInput.value = today.end;
        
        // Carrega automaticamente os dados do dia atual
        fetchPicos();
      }
    }

    // Event listener para o bot√£o de buscar picos
    $("fetchPicos").addEventListener("click", () => fetchPicos());

    // Fun√ß√£o para exportar tabela de leituras integrais para Excel (XLSX)
    function exportDataTableToExcel(filename) {
      if (tableData.length === 0) {
        alert("N√£o h√° dados para exportar.");
        return;
      }

      if (typeof XLSX === "undefined") {
        alert("Biblioteca XLSX n√£o carregada. Por favor, recarregue a p√°gina.");
        return;
      }

      // Determina quais colunas mostrar baseado no filtro atual
      const seriesMode = $("seriesMode").value;
      const showPm1 = seriesMode === "pm25_pm1" || seriesMode === "all";
      const showPm10 = seriesMode === "pm25_pm10" || seriesMode === "all";

      // Obt√©m valores dos filtros
      let dataInicio = "";
      let dataFim = "";
      
      if (mode.type === "last_minutes") {
        dataInicio = `√öltimos ${mode.minutes} minutos`;
        dataFim = `√öltimos ${mode.minutes} minutos`;
      } else {
        const startDt = $("startDt").value;
        const endDt = $("endDt").value;
        dataInicio = startDt || "";
        dataFim = endDt || "";
      }

      // Cria cabe√ßalhos
      const headers = ["Data In√≠cio", "Data Fim", "Data e Hora"];
      if (showPm1) headers.push("PM1.0 (¬µg/m¬≥)");
      headers.push("PM2.5 (¬µg/m¬≥)");
      if (showPm10) headers.push("PM10 (¬µg/m¬≥)");

      // Ordena dados se necess√°rio
      let sortedData = [...tableData];
      if (currentSort.column && currentSort.direction) {
        sortedData.sort((a, b) => {
          let aVal, bVal;
          if (currentSort.column === 'time') {
            aVal = new Date(a.timeIso).getTime();
            bVal = new Date(b.timeIso).getTime();
          } else {
            aVal = a[currentSort.column] !== null ? a[currentSort.column] : -Infinity;
            bVal = b[currentSort.column] !== null ? b[currentSort.column] : -Infinity;
          }
          if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
          if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
          return 0;
        });
      } else {
        sortedData.reverse(); // Mais recente primeiro
      }

      // Cria dados da planilha
      const data = [headers];
      sortedData.forEach(item => {
        // Formata data e hora usando a mesma fun√ß√£o da interface
        const dateTimeStr = fmtTime(item.timeIso).replace(" BRT", ""); // Remove "BRT" para o Excel
        
        const row = [dataInicio, dataFim, dateTimeStr];
        if (showPm1) row.push(item.pm1 !== null ? item.pm1 : "");
        row.push(item.pm25 !== null ? item.pm25 : "");
        if (showPm10) row.push(item.pm10 !== null ? item.pm10 : "");
        data.push(row);
      });

      // Cria a planilha
      const ws = XLSX.utils.aoa_to_sheet(data);
      
      // Ajusta largura das colunas
      const colWidths = headers.map((_, colIndex) => {
        let maxLength = headers[colIndex].length;
        data.slice(1).forEach(row => {
          const cellValue = row[colIndex];
          const length = cellValue ? String(cellValue).length : 0;
          if (length > maxLength) maxLength = length;
        });
        return { wch: Math.max(maxLength + 2, 12) };
      });
      ws['!cols'] = colWidths;

      // Cria workbook e exporta
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Leituras");
      XLSX.writeFile(wb, filename);
    }

    // Fun√ß√£o para exportar tabela de picos para Excel (XLSX)
    function exportPicosTableToExcel(filename) {
      if (picosData.length === 0) {
        alert("N√£o h√° dados para exportar.");
        return;
      }

      if (typeof XLSX === "undefined") {
        alert("Biblioteca XLSX n√£o carregada. Por favor, recarregue a p√°gina.");
        return;
      }

      // Obt√©m valores dos filtros de picos
      const picosStartDt = $("picosStartDt").value || "";
      const picosEndDt = $("picosEndDt").value || "";

      // Fun√ß√£o auxiliar para formatar apenas a data
      function fmtDate(isoZ) {
        try {
          const date = new Date(isoZ);
          const formatter = new Intl.DateTimeFormat("pt-BR", {
            timeZone: "America/Sao_Paulo",
            year: "numeric",
            month: "2-digit",
            day: "2-digit"
          });
          return formatter.format(date);
        } catch {
          return isoZ;
        }
      }

      // Cria cabe√ßalhos
      const headers = ["Data In√≠cio", "Data Fim", "Data", "Data e Hora", "Valor Anterior (¬µg/m¬≥)", "Valor Atual (¬µg/m¬≥)", "Aumento (¬µg/m¬≥)"];

      // Cria dados da planilha usando timestamps originais
      const data = [headers];
      picosData.forEach(occ => {
        // Formata apenas a data
        const dateStr = fmtDate(occ.timestamp);
        // Formata data e hora usando a mesma fun√ß√£o da interface
        const dateTimeStr = fmtTime(occ.timestamp).replace(" BRT", ""); // Remove "BRT" para o Excel
        
        const row = [
          picosStartDt,
          picosEndDt,
          dateStr,
          dateTimeStr,
          occ.previous_value !== null && occ.previous_value !== undefined ? Number(occ.previous_value) : "",
          occ.current_value !== null && occ.current_value !== undefined ? Number(occ.current_value) : "",
          occ.increase !== null && occ.increase !== undefined ? Number(occ.increase) : ""
        ];
        data.push(row);
      });

      // Cria a planilha
      const ws = XLSX.utils.aoa_to_sheet(data);
      
      // Ajusta largura das colunas
      const colWidths = [
        { wch: 18 }, // Data In√≠cio
        { wch: 18 }, // Data Fim
        { wch: 12 }, // Data
        { wch: 20 }, // Data e Hora
        { wch: 18 }, // Valor Anterior
        { wch: 16 }, // Valor Atual
        { wch: 16 }  // Aumento
      ];
      ws['!cols'] = colWidths;

      // Cria workbook e exporta
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Picos");
      XLSX.writeFile(wb, filename);
    }

    // Event listeners para exporta√ß√£o
    const exportPicosBtn = document.getElementById("exportPicos");
    if (exportPicosBtn) {
      exportPicosBtn.addEventListener("click", () => {
        const startDate = $("picosStartDt").value || "inicio";
        const endDate = $("picosEndDt").value || "fim";
        const filename = `picos_pm25_${startDate}_${endDate}.xlsx`.replace(/:/g, "-");
        exportPicosTableToExcel(filename);
      });
    }

    const exportDataBtn = document.getElementById("exportData");
    if (exportDataBtn) {
      exportDataBtn.addEventListener("click", () => {
        const now = new Date();
        const dateStr = now.toISOString().split("T")[0];
        const filename = `leituras_integrais_${dateStr}.xlsx`;
        exportDataTableToExcel(filename);
      });
    }

    // Accordion do Disclaimer
    const disclaimerAccordion = document.getElementById("disclaimerAccordion");
    const disclaimerHeader = document.getElementById("disclaimerHeader");
    
    if (disclaimerHeader) {
      disclaimerHeader.addEventListener("click", () => {
        disclaimerAccordion.classList.toggle("active");
      });
    }

    // Inicializa
    drawGauge(null); // Desenha o veloc√≠metro inicialmente
    resetTimerIfNeeded();
    reloadNow();
    initPicosDateRange(); // Inicializa os campos de picos com o dia atual
  </script>
</body>
</html>
